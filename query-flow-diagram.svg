<?xml version="1.0" encoding="UTF-8"?>
<svg width="1200" height="800" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .frontend-box { fill: #e3f2fd; stroke: #1976d2; stroke-width: 2; }
      .backend-box { fill: #f3e5f5; stroke: #7b1fa2; stroke-width: 2; }
      .api-box { fill: #fff3e0; stroke: #f57c00; stroke-width: 2; }
      .rag-box { fill: #e8f5e8; stroke: #388e3c; stroke-width: 2; }
      .ai-box { fill: #fce4ec; stroke: #c2185b; stroke-width: 2; }
      .db-box { fill: #f1f8e9; stroke: #689f38; stroke-width: 2; }
      
      .title-text { font-family: Arial, sans-serif; font-size: 14px; font-weight: bold; }
      .detail-text { font-family: Arial, sans-serif; font-size: 11px; fill: #333; }
      .flow-text { font-family: Arial, sans-serif; font-size: 10px; fill: #666; }
      
      .arrow { stroke: #333; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .return-arrow { stroke: #666; stroke-width: 2; fill: none; marker-end: url(#arrowhead); stroke-dasharray: 5,5; }
    </style>
    
    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
            refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
    </marker>
  </defs>
  
  <!-- Title -->
  <text x="600" y="25" text-anchor="middle" class="title-text" font-size="18" fill="#333">
    RAG Chatbot: Query Processing Flow
  </text>
  
  <!-- Frontend Section -->
  <rect x="50" y="60" width="300" height="120" rx="8" class="frontend-box"/>
  <text x="200" y="80" text-anchor="middle" class="title-text" fill="#1976d2">FRONTEND</text>
  
  <!-- User Input -->
  <rect x="70" y="90" width="120" height="40" rx="4" fill="#bbdefb" stroke="#1565c0"/>
  <text x="130" y="105" text-anchor="middle" class="detail-text">User Input</text>
  <text x="130" y="118" text-anchor="middle" class="flow-text">script.js:45</text>
  
  <!-- Send Message -->
  <rect x="210" y="90" width="120" height="40" rx="4" fill="#bbdefb" stroke="#1565c0"/>
  <text x="270" y="105" text-anchor="middle" class="detail-text">sendMessage()</text>
  <text x="270" y="118" text-anchor="middle" class="flow-text">POST /api/query</text>
  
  <!-- API Layer -->
  <rect x="50" y="220" width="300" height="80" rx="8" class="api-box"/>
  <text x="200" y="240" text-anchor="middle" class="title-text" fill="#f57c00">FASTAPI ENDPOINT</text>
  
  <rect x="70" y="250" width="260" height="40" rx="4" fill="#ffe0b2" stroke="#ef6c00"/>
  <text x="200" y="265" text-anchor="middle" class="detail-text">query_documents()</text>
  <text x="200" y="278" text-anchor="middle" class="flow-text">app.py:56 - Session Management</text>
  
  <!-- RAG System -->
  <rect x="450" y="220" width="280" height="120" rx="8" class="rag-box"/>
  <text x="590" y="240" text-anchor="middle" class="title-text" fill="#388e3c">RAG SYSTEM</text>
  
  <rect x="470" y="250" width="120" height="35" rx="4" fill="#c8e6c9" stroke="#2e7d32"/>
  <text x="530" y="265" text-anchor="middle" class="detail-text">RAGSystem</text>
  <text x="530" y="275" text-anchor="middle" class="flow-text">rag_system.py:102</text>
  
  <rect x="600" y="250" width="120" height="35" rx="4" fill="#c8e6c9" stroke="#2e7d32"/>
  <text x="660" y="265" text-anchor="middle" class="detail-text">SessionManager</text>
  <text x="660" y="275" text-anchor="middle" class="flow-text">Get History</text>
  
  <rect x="470" y="295" width="240" height="35" rx="4" fill="#c8e6c9" stroke="#2e7d32"/>
  <text x="590" y="310" text-anchor="middle" class="detail-text">AI Generator + Tools</text>
  <text x="590" y="320" text-anchor="middle" class="flow-text">ai_generator.py:43</text>
  
  <!-- AI Processing -->
  <rect x="800" y="220" width="320" height="160" rx="8" class="ai-box"/>
  <text x="960" y="240" text-anchor="middle" class="title-text" fill="#c2185b">AI PROCESSING</text>
  
  <rect x="820" y="250" width="130" height="35" rx="4" fill="#f8bbd9" stroke="#ad1457"/>
  <text x="885" y="265" text-anchor="middle" class="detail-text">Claude API Call</text>
  <text x="885" y="275" text-anchor="middle" class="flow-text">With Tools</text>
  
  <rect x="970" y="250" width="130" height="35" rx="4" fill="#f8bbd9" stroke="#ad1457"/>
  <text x="1035" y="265" text-anchor="middle" class="detail-text">Tool Execution</text>
  <text x="1035" y="275" text-anchor="middle" class="flow-text">CourseSearchTool</text>
  
  <rect x="820" y="295" width="280" height="35" rx="4" fill="#f8bbd9" stroke="#ad1457"/>
  <text x="960" y="310" text-anchor="middle" class="detail-text">Vector Search</text>
  <text x="960" y="320" text-anchor="middle" class="flow-text">search_tools.py:52 → vector_store.py</text>
  
  <rect x="820" y="340" width="280" height="35" rx="4" fill="#f8bbd9" stroke="#ad1457"/>
  <text x="960" y="355" text-anchor="middle" class="detail-text">Response Generation</text>
  <text x="960" y="365" text-anchor="middle" class="flow-text">Based on Search Results</text>
  
  <!-- Database -->
  <rect x="800" y="420" width="320" height="80" rx="8" class="db-box"/>
  <text x="960" y="440" text-anchor="middle" class="title-text" fill="#689f38">VECTOR DATABASE</text>
  
  <rect x="820" y="450" width="130" height="40" rx="4" fill="#dcedc8" stroke="#558b2f"/>
  <text x="885" y="465" text-anchor="middle" class="detail-text">ChromaDB</text>
  <text x="885" y="478" text-anchor="middle" class="flow-text">Course Content</text>
  
  <rect x="970" y="450" width="130" height="40" rx="4" fill="#dcedc8" stroke="#558b2f"/>
  <text x="1035" y="465" text-anchor="middle" class="detail-text">Embeddings</text>
  <text x="1035" y="478" text-anchor="middle" class="flow-text">Semantic Search</text>
  
  <!-- Response Flow Back -->
  <rect x="50" y="550" width="1070" height="80" rx="8" class="backend-box"/>
  <text x="585" y="570" text-anchor="middle" class="title-text" fill="#7b1fa2">RESPONSE FLOW</text>
  
  <rect x="70" y="580" width="150" height="40" rx="4" fill="#e1bee7" stroke="#6a1b9a"/>
  <text x="145" y="595" text-anchor="middle" class="detail-text">Format Response</text>
  <text x="145" y="608" text-anchor="middle" class="flow-text">QueryResponse Model</text>
  
  <rect x="250" y="580" width="150" height="40" rx="4" fill="#e1bee7" stroke="#6a1b9a"/>
  <text x="325" y="595" text-anchor="middle" class="detail-text">Update Session</text>
  <text x="325" y="608" text-anchor="middle" class="flow-text">Store Conversation</text>
  
  <rect x="430" y="580" width="150" height="40" rx="4" fill="#e1bee7" stroke="#6a1b9a"/>
  <text x="505" y="595" text-anchor="middle" class="detail-text">Return JSON</text>
  <text x="505" y="608" text-anchor="middle" class="flow-text">{answer, sources, session_id}</text>
  
  <rect x="610" y="580" width="150" height="40" rx="4" fill="#e1bee7" stroke="#6a1b9a"/>
  <text x="685" y="595" text-anchor="middle" class="detail-text">Frontend Update</text>
  <text x="685" y="608" text-anchor="middle" class="flow-text">Remove Loading</text>
  
  <rect x="790" y="580" width="150" height="40" rx="4" fill="#e1bee7" stroke="#6a1b9a"/>
  <text x="865" y="595" text-anchor="middle" class="detail-text">Render Response</text>
  <text x="865" y="608" text-anchor="middle" class="flow-text">Markdown + Sources</text>
  
  <rect x="970" y="580" width="130" height="40" rx="4" fill="#e1bee7" stroke="#6a1b9a"/>
  <text x="1035" y="595" text-anchor="middle" class="detail-text">Update UI</text>
  <text x="1035" y="608" text-anchor="middle" class="flow-text">Chat Messages</text>
  
  <!-- Flow Arrows -->
  <!-- Frontend to API -->
  <line x1="200" y1="180" x2="200" y2="220" class="arrow"/>
  <text x="210" y="205" class="flow-text">1. HTTP POST</text>
  
  <!-- API to RAG -->
  <line x1="350" y1="260" x2="450" y2="260" class="arrow"/>
  <text x="375" y="255" class="flow-text">2. Process Query</text>
  
  <!-- RAG to AI -->
  <line x1="730" y1="280" x2="800" y2="280" class="arrow"/>
  <text x="740" y="275" class="flow-text">3. Generate</text>
  
  <!-- AI to Database -->
  <line x1="960" y1="380" x2="960" y2="420" class="arrow"/>
  <text x="970" y="405" class="flow-text">4. Search</text>
  
  <!-- Database back to AI -->
  <line x1="1000" y1="420" x2="1000" y2="380" class="return-arrow"/>
  <text x="1010" y="405" class="flow-text">5. Results</text>
  
  <!-- AI back to RAG -->
  <line x1="800" y1="300" x2="730" y2="300" class="return-arrow"/>
  <text x="740" y="295" class="flow-text">6. Response</text>
  
  <!-- RAG back to API -->
  <line x1="450" y1="280" x2="350" y2="280" class="return-arrow"/>
  <text x="375" y="275" class="flow-text">7. Answer</text>
  
  <!-- API back to Frontend -->
  <line x1="200" y1="300" x2="200" y2="340" class="return-arrow"/>
  <line x1="200" y1="340" x2="70" y2="550" class="return-arrow"/>
  <text x="110" y="445" class="flow-text">8. JSON Response</text>
  
  <!-- Data Flow Labels -->
  <rect x="50" y="680" width="1070" height="100" rx="8" fill="#f5f5f5" stroke="#999"/>
  <text x="585" y="700" text-anchor="middle" class="title-text" fill="#333">DATA FLOW SUMMARY</text>
  
  <text x="70" y="720" class="detail-text" fill="#333">
    <tspan x="70" dy="0">1. User types query → sendMessage() captures input</tspan>
    <tspan x="70" dy="15">2. POST /api/query with {query, session_id} → FastAPI receives request</tspan>
    <tspan x="70" dy="15">3. RAGSystem.query() → SessionManager retrieves conversation history</tspan>
    <tspan x="70" dy="15">4. AIGenerator calls Claude API with tools → CourseSearchTool searches vector store</tspan>
    <tspan x="70" dy="15">5. ChromaDB semantic search → Returns relevant course content</tspan>
    <tspan x="70" dy="15">6. Claude generates response based on search results → Returns formatted answer with sources</tspan>
  </text>
</svg>